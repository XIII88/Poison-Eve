<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poison Eve AI</title>
    
    <link rel="icon" href="icon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Marked Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        poison: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#052e16',
                            950: '#021208',
                        },
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #22c55e' },
                            '100%': { boxShadow: '0 0 20px #4ade80, 0 0 10px #22c55e' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, hsla(142, 69%, 15%, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(280, 50%, 15%, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(142, 69%, 10%, 0.3) 0px, transparent 50%);
            background-attachment: fixed;
            color: #e5e7eb;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Custom Scrollbar (Optimized for dark theme) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #15803d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }

        /* Markdown Styles (Optimized) */
        .prose pre {
            background-color: #0f1210;
            border: 1px solid #166534;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding: 0;
            border-radius: 0.5rem;
        }
        
        .prose code {
            color: #4ade80;
            background-color: rgba(22, 163, 74, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-weight: 400;
            transition: background-color 0.1s ease; 
        }
        
        .prose pre code {
            color: inherit;
            background-color: transparent;
            padding: 1rem;
            display: block;
            overflow-x: auto;
        }
        
        /* IMAGE STYLES FOR CHAT (Оптимизация: Адаптивность и тени) */
        .prose img {
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.7);
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(34, 197, 94, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .code-container {
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #0f1210;
            border: 1px solid #166534;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: rgba(34, 197, 94, 0.1);
            border-bottom: 1px solid #166534;
            color: #86efac;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .prose table {
            display: block;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            border-color: #333;
            margin-bottom: 1rem;
        }
        .prose th {
            color: #86efac;
            border-bottom: 1px solid #15803d;
            padding: 8px 16px;
        }
        .prose td {
            border-bottom: 1px solid #333;
            padding: 8px 16px;
        }

        .prose strong { color: #fff; font-weight: 700; }
        .prose h1, .prose h2, .prose h3 { color: #86efac; }
        .prose a { color: #4ade80; text-decoration: underline; }
        .prose blockquote { border-left-color: #22c55e; color: #d1d5db; }

        /* Glassmorphism & UI */
        .glass-panel {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(34, 197, 94, 0.1);
        }

        .message-user {
            background: linear-gradient(135deg, #166534 0%, #14532d 100%);
            border: 1px solid #22c55e;
            box-shadow: 0 4px 15px -3px rgba(34, 197, 94, 0.2);
            border-radius: 1rem 1rem 0.2rem 1rem;
        }
        
        .message-ai {
            background: transparent;
            border: none;
            box-shadow: none;
            padding-left: 0;
            padding-right: 0;
        }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .model-toggle {
            @apply flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-mono border transition-all duration-300 cursor-pointer select-none;
        }
        .model-toggle[data-mode="small"] {
            @apply bg-gray-900/50 border-white/10 text-gray-400 hover:text-green-400 hover:border-green-500/30;
        }
        .model-toggle[data-mode="large"] {
            @apply bg-green-900/30 border-green-500/50 text-green-400 shadow-[0_0_10px_rgba(34,197,94,0.1)];
        }
    </style>
</head>
<body class="antialiased selection:bg-green-500/30 selection:text-green-50">

    <!-- Header -->
    <header class="glass-panel flex-none sticky top-0 z-50 flex items-center justify-between px-4 py-3 border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="relative w-10 h-10 flex items-center justify-center rounded-xl bg-gradient-to-tr from-green-900 to-black border border-green-500/30 shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                <i class="fa-solid fa-leaf text-green-400 text-lg"></i>
                <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]"></div>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white via-green-100 to-green-400 uppercase font-sans">
                    Poison Eve
                </h1>
                <p class="text-[10px] text-green-400/60 font-mono tracking-widest">MISTRAL.AI // SYSTEM ACTIVE</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button id="model-toggle" class="model-toggle" onclick="toggleModel()" data-mode="large" title="Переключить модель (Turbo/Smart)">
                <i id="model-icon" class="fa-solid fa-brain"></i>
                <span id="model-text">LARGE</span>
            </button>

            <!-- Используем showConfirmModal() для вызова пользовательского модального окна -->
            <button onclick="showConfirmModal()" class="p-2 rounded-lg text-gray-400 hover:text-green-400 hover:bg-white/5 transition-all duration-300" title="Очистить историю">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth pb-28">
        <div class="flex flex-col items-center justify-center mt-10 opacity-70 mb-10 text-center space-y-4 animate-fade-in">
            <div class="w-20 h-20 rounded-full bg-green-900/20 border border-green-500/20 flex items-center justify-center shadow-[0_0_30px_rgba(34,197,94,0.1)]">
                <i class="fa-solid fa-robot text-3xl text-green-500"></i>
            </div>
            <h2 class="text-2xl font-semibold text-white">Готова к работе</h2>
        </div>
    </main>

    <!-- Input Area -->
    <footer id="footer" class="flex-none p-2 md:p-6 bg-transparent w-full z-40">
        <div class="glass-panel w-full md:max-w-5xl mx-auto rounded-2xl p-2 relative shadow-2xl shadow-black/50">
            <form id="chat-form" class="flex gap-2 items-end">
                <div class="relative flex-1">
                    <textarea 
                        id="user-input" 
                        rows="1"
                        placeholder="Напишите сообщение..." 
                        class="w-full bg-transparent text-gray-100 placeholder-gray-500 text-base rounded-xl px-4 py-3 focus:outline-none border border-transparent focus:border-green-500/30 transition-all resize-none max-h-40 font-sans"
                        oninput="handleInput(this)"
                        onfocus="focusInput()"
                        onblur="focusBlur()"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                </div>
                <button 
                    type="submit" 
                    id="send-btn"
                    class="h-[50px] w-[50px] flex-shrink-0 rounded-xl bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/50 transition-all duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed group"
                >
                    <i class="fa-solid fa-paper-plane text-lg group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"></i>
                </button>
            </form>
        </div>
    </footer>

    <!-- Custom Confirmation Modal (Замена window.confirm()) -->
    <div id="confirm-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/70 transition-opacity duration-300">
        <div class="glass-panel w-11/12 max-w-sm rounded-xl p-6 space-y-4 border-green-500/30 shadow-2xl shadow-green-900/50" role="dialog" aria-modal="true">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i>
                Очистить историю?
            </h3>
            <p class="text-gray-400 text-sm">
                Вы уверены, что хотите удалить всю историю чата? Это действие нельзя отменить.
            </p>
            <div class="flex justify-end gap-3">
                <button 
                    onclick="hideConfirmModal()" 
                    class="px-4 py-2 text-sm rounded-lg text-gray-300 border border-gray-700 hover:bg-white/5 transition-colors"
                >
                    Отмена
                </button>
                <button 
                    onclick="confirmClearChat()" 
                    class="px-4 py-2 text-sm rounded-lg bg-red-600 hover:bg-red-500 text-white transition-colors shadow-md shadow-red-900/50"
                >
                    Очистить
                </button>
            </div>
        </div>
    </div>
    <!-- End Custom Confirmation Modal -->

    <script>
        // --- CONFIGURATION ---
        // Ключ и URL API Mistral
        const API_KEY = 'Tjx8hlgYwDWL2tr9YpACDX2kSEFXmSFq';
        const API_URL = 'https://api.mistral.ai/v1/chat/completions';
        
        const MODELS = {
            small: 'mistral-small-latest',
            large: 'mistral-large-latest'
        };
        let currentModel = MODELS.large; 
        
        let isChatStarted = false; 

        let chatHistory = [
            { role: "system", content: "Ты — Poison Eve, продвинутый и стильный ИИ-ассистент. Отвечай точно, используй Markdown (жирный шрифт, таблицы, списки) для структурирования информации. Если нужно показать изображение, используй синтаксис Markdown: ![Описание](URL изображения). Выделения текста не работают в блоках." }
        ];

        // --- DOM ELEMENTS ---
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const confirmModal = document.getElementById('confirm-modal');
        
        const toggleBtn = document.getElementById('model-toggle');
        const toggleIcon = document.getElementById('model-icon');
        const toggleText = document.getElementById('model-text');

        // --- MODAL & CONFIRMATION LOGIC ---

        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }

        function hideConfirmModal() {
            confirmModal.classList.remove('flex');
            confirmModal.classList.add('hidden');
        }

        function confirmClearChat() {
            hideConfirmModal();
            clearChatHistory();
        }
        
        function clearChatHistory() {
            chatContainer.innerHTML = '';
            // Сбрасываем историю до системного промпта
            chatHistory = [chatHistory[0]];
            
            isChatStarted = false;
            updateModelToggleState(); 

            // Показываем приветственное сообщение
            chatContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center mt-10 opacity-70 mb-10 text-center space-y-4 animate-fade-in">
                    <div class="w-20 h-20 rounded-full bg-green-900/20 border border-green-500/20 flex items-center justify-center shadow-[0_0_30px_rgba(34,197,94,0.1)]">
                        <i class="fa-solid fa-robot text-3xl text-green-500"></i>
                    </div>
                    <h2 class="text-2xl font-semibold text-white">Готова к работе</h2>
                </div>
            `;
        }

        // --- MODEL TOGGLE LOGIC ---
        function updateModelToggleState() {
            const toggleBtn = document.getElementById('model-toggle');
            if (isChatStarted) {
                toggleBtn.disabled = true;
                toggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                toggleBtn.classList.remove('hover:text-green-400', 'hover:border-green-500/30'); 
            } else {
                toggleBtn.disabled = false;
                toggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function toggleModel() {
            if (isChatStarted) return; 

            const currentMode = toggleBtn.getAttribute('data-mode');
            if (currentMode === 'large') {
                currentModel = MODELS.small;
                toggleBtn.setAttribute('data-mode', 'small');
                toggleIcon.className = 'fa-solid fa-bolt';
                toggleText.textContent = 'FAST';
            } else {
                currentModel = MODELS.large;
                toggleBtn.setAttribute('data-mode', 'large');
                toggleIcon.className = 'fa-solid fa-brain';
                toggleText.textContent = 'LARGE';
            }
            updateModelToggleState();
        }

        // --- MARKED SETUP ---
        marked.setOptions({
            // Оптимизация: используем highlight.js только для обычных языков, но не для 'markdown'
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                     // Для блока 'markdown' используем его грамматику, чтобы получить нужные классы (hljs-strong, hljs-section)
                    if (lang.toLowerCase() === 'markdown') {
                        return hljs.highlight(code, { language: 'markdown' }).value;
                    }
                    // Для всех остальных языков - стандартная подсветка
                    return hljs.highlight(code, { language: lang }).value;
                }
                // Автоматическое определение, если язык не указан
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // --- UI UTILITIES ---
        function handleInput(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
            scrollToBottom(); 
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }
        
        function focusInput() {
            setTimeout(() => {
                 scrollToBottom();
                 chatContainer.scrollTop += 50; 
            }, 300);
        }

        function focusBlur() {}

        // --- COPY CODE LOGIC (Оптимизация: Modern Clipboard API + Fallback) ---
        function copyCode(button) {
            const codeBlock = button.parentElement.nextElementSibling.querySelector('code');
            if (!codeBlock) return;

            const textToCopy = codeBlock.innerText;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess(button);
                }).catch(() => {
                    // Fallback, если Modern API не сработало (например, в iframe)
                    fallbackCopy(textToCopy, button);
                });
            } else {
                fallbackCopy(textToCopy, button);
            }
        }
        
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function showCopySuccess(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Скопировано!';
            button.classList.add('bg-green-700');
            button.classList.remove('hover:bg-green-600');

            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-700');
                button.classList.add('hover:bg-green-600');
            }, 2000);
        }

        function addCopyButtons(element) {
            element.querySelectorAll('pre').forEach(pre => {
                const codeElement = pre.querySelector('code');
                let lang = 'Code';
                if (codeElement && codeElement.className) {
                    const match = codeElement.className.match(/language-(\w+)/);
                    if (match) {
                        lang = match[1].charAt(0).toUpperCase() + match[1].slice(1);
                        if (lang.toLowerCase() === 'markdown') {
                            lang = 'Markdown Content';
                        }
                    }
                }

                // Предотвращаем добавление кнопок дважды
                if (pre.parentNode.classList.contains('code-container')) return;

                const container = document.createElement('div');
                container.className = 'code-container';

                const header = document.createElement('div');
                header.className = 'code-header';

                const langLabel = document.createElement('span');
                langLabel.textContent = lang;
                header.appendChild(langLabel);

                const copyButton = document.createElement('button');
                copyButton.className = 'px-2 py-1 rounded text-white bg-green-800 hover:bg-green-600 transition-colors focus:outline-none text-xs';
                copyButton.innerHTML = '<i class="fa-solid fa-copy mr-1"></i> Копировать';
                
                copyButton.onclick = () => copyCode(copyButton);
                
                header.appendChild(copyButton);

                const parent = pre.parentNode;
                if (parent) {
                    // Оборачиваем pre в контейнер с шапкой
                    container.appendChild(header);
                    parent.insertBefore(container, pre);
                    container.appendChild(pre);
                }
            });
        }

        // --- EVENT LISTENERS ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await sendMessage();
        });

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (window.innerWidth > 768) {
                    e.preventDefault();
                    sendMessage();
                }
            }
        }
        
        // --- CORE FUNCTIONS ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            appendMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto'; 
            
            const loadingId = appendLoading();
            disableInput(true);

            chatHistory.push({ role: "user", content: text });

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 12000
                    })
                });

                if (!response.ok) {
                    throw new Error(`Status: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                chatHistory.push({ role: "assistant", content: aiResponse });
                removeLoading(loadingId);
                const newMessage = appendMessage('assistant', aiResponse);
                
                if (newMessage) {
                    addCopyButtons(newMessage);
                }
                
                if (!isChatStarted) {
                    isChatStarted = true;
                    updateModelToggleState();
                }

            } catch (error) {
                removeLoading(loadingId);
                console.error("API Error Log:", error);
                appendMessage('assistant', `Извините, произошла ошибка API: ${error.message}. Попробуйте еще раз.`);
            } finally {
                disableInput(false);
                scrollToBottom();
            }
        }

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    } else {
                        return response; 
                    }
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw error;
                }
            }
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bubbleClasses = isUser 
                ? 'message-user text-white px-5 py-3 shadow-md overflow-hidden min-w-[30%]' 
                : 'message-ai text-gray-100 overflow-hidden w-full';

            const icon = isUser 
                ? '<i class="fa-solid fa-user"></i>' 
                : '<i class="fa-solid fa-dragon"></i>';

            const iconContainer = `
                <div class="flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center ${isUser ? 'bg-green-700 ml-2' : 'bg-transparent text-green-400 mr-3 border border-green-500/30'}">
                    ${icon}
                </div>
            `;

            const contentWrapper = document.createElement('div');
            
            if (isUser) {
                contentWrapper.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
            } else {
                contentWrapper.innerHTML = marked.parse(content);
            }

            const messageHtml = `
                <div class="flex max-w-full md:max-w-[95%] ${isUser ? 'flex-row-reverse items-end' : 'flex-row items-start'}">
                    ${iconContainer}
                    <div id="message-bubble-${Date.now()}" class="${bubbleClasses}">
                        <div class="prose prose-invert prose-sm md:prose-base max-w-none break-words leading-relaxed" id="prose-content-${Date.now()}">
                            ${contentWrapper.innerHTML}
                        </div>
                    </div>
                </div>
            `;

            div.innerHTML = messageHtml;
            chatContainer.appendChild(div);
            scrollToBottom();
            
            return div.querySelector('.prose'); 
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex w-full justify-start animate-fade-in';
            div.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-transparent text-green-400 mr-3 border border-green-500/30 flex items-center justify-center">
                        <i class="fa-solid fa-dragon text-xs"></i>
                    </div>
                    <div class="message-ai py-2 flex items-center gap-1">
                        <div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-green-500 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function disableInput(disabled) {
            userInput.disabled = disabled;
            sendBtn.disabled = disabled;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        document.addEventListener('DOMContentLoaded', updateModelToggleState);
    </script>
</body>
</html>


