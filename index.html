<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poison Eve AI</title>
    
    <link rel="icon" href="icon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Marked Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Marked Footnote Extension -->
    <script src="https://cdn.jsdelivr.net/npm/marked-footnote/dist/index.umd.min.js"></script>
    
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        poison: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#052e16',
                            950: '#021208',
                        },
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out forwards',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #22c55e' },
                            '100%': { boxShadow: '0 0 20px #4ade80, 0 0 10px #22c55e' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, hsla(142, 69%, 15%, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(280, 50%, 15%, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(142, 69%, 10%, 0.3) 0px, transparent 50%);
            background-attachment: fixed;
            color: #e5e7eb;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #15803d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }

        /* Markdown Styles */
        .prose pre {
            background-color: #0f1210;
            border: 1px solid #166534;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –±–ª–æ–∫–∞ */
            padding: 1rem !important; 
            border-radius: 0.5rem;
            overflow-x: auto;
            position: relative; /* Context for positioning if needed */
        }
        
        /* Highlight.js overrides */
        .hljs {
            background: transparent !important;
            padding: 0 !important;
        }

        /* NUCLEAR OPTION for removing bold/italics inside code blocks */
        .prose pre code, 
        .prose pre code span, 
        .hljs-strong, 
        .hljs-emphasis,
        code[class*="language-"] *,
        pre[class*="language-"] * {
            font-weight: normal !important;
            font-style: normal !important;
        }

        .prose code {
            color: #4ade80;
            background-color: rgba(22, 163, 74, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-weight: 400;
            font-family: 'JetBrains Mono', monospace;
            transition: background-color 0.1s ease; 
        }
        
        /* Code inside PRE blocks */
        .prose pre code {
            color: inherit;
            background-color: transparent;
            padding: 0 0 1.5rem 0 !important; 
            display: block;
            min-width: 100%;
            /* Ensure line height is consistent */
            line-height: 1.5; 
        }
        
        .prose img {
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.7);
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .code-container {
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #0f1210;
            border: 1px solid #166534;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: rgba(34, 197, 94, 0.1);
            border-bottom: 1px solid #166534;
            color: #86efac;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }
        /* Remove border/radius from pre when inside container to look seamless */
        .code-container pre {
            margin: 0;
            border: none;
            border-radius: 0;
            border-top: none; 
        }

        .prose table {
            display: block;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            border-color: #333;
            margin-bottom: 1rem;
        }
        .prose th {
            color: #86efac;
            border-bottom: 1px solid #15803d;
            padding: 8px 16px;
        }
        .prose td {
            border-bottom: 1px solid #333;
            padding: 8px 16px;
        }

        .prose strong { color: #fff; font-weight: 700; }
        .prose h1, .prose h2, .prose h3 { color: #86efac; }
        .prose a { color: #4ade80; text-decoration: underline; }
        .prose blockquote { border-left-color: #22c55e; color: #d1d5db; }

        .footnotes {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(22, 163, 74, 0.4);
            font-size: 0.85rem;
            color: #9ca3af;
        }
        sup { color: #4ade80; font-weight: bold; }
        sup a { text-decoration: none !important; }
        .footnote-backref { color: #22c55e; text-decoration: none; margin-left: 0.25rem; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(34, 197, 94, 0.1);
        }

        .message-user {
            background: linear-gradient(135deg, #166534 0%, #14532d 100%);
            border: 1px solid #22c55e;
            box-shadow: 0 4px 15px -3px rgba(34, 197, 94, 0.2);
            border-radius: 1rem 1rem 0.2rem 1rem;
        }
        
        .message-ai {
            background: transparent;
            border: none;
            box-shadow: none;
            padding-left: 0;
            padding-right: 0;
        }

        .model-toggle {
            @apply flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-mono border transition-all duration-300 cursor-pointer select-none;
        }
        .model-toggle[data-mode="small"] {
            @apply bg-gray-900/50 border-white/10 text-gray-400 hover:text-green-400 hover:border-green-500/30;
        }
        .model-toggle[data-mode="large"] {
            @apply bg-green-900/30 border-green-500/50 text-green-400 shadow-[0_0_10px_rgba(34,197,94,0.1)];
        }

        .typing-cursor::after {
            content: '‚ñã';
            display: inline-block;
            vertical-align: baseline;
            animation: blink 1s step-end infinite;
            color: #22c55e;
            margin-left: 2px;
            font-size: 0.9em;
        }
        @keyframes blink { 
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* Thinking Animation */
        .thinking-container {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 0;
        }
        .thinking-dot {
            width: 6px;
            height: 6px;
            background-color: #4ade80;
            border-radius: 50%;
            animation: poison-pulse 1.4s infinite ease-in-out both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes poison-pulse {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; box-shadow: 0 0 0 rgba(74, 222, 128, 0); }
            40% { transform: scale(1); opacity: 1; box-shadow: 0 0 8px rgba(74, 222, 128, 0.6); }
        }
        
        .stop-btn { background-color: #ef4444; }
        .stop-btn:hover { background-color: #dc2626; }
    </style>
</head>
<body class="antialiased selection:bg-green-500/30 selection:text-green-50">

    <input type="file" id="file-input" class="hidden" accept=".txt,.md,.js,.json,.html,.css,.py,.c,.cpp,.h,.java,.xml,.log,text/*" onchange="handleFileSelect(this)">

    <!-- Header -->
    <header class="glass-panel flex-none sticky top-0 z-50 flex flex-col border-b border-white/5 transition-all duration-300">
        <div class="flex items-center justify-between px-4 py-3 relative z-20 bg-black/20 backdrop-blur-sm">
            <!-- Left Side: Logo -->
            <div class="flex items-center gap-3">
                <div class="relative w-10 h-10 flex items-center justify-center rounded-xl bg-gradient-to-tr from-green-900 to-black border border-green-500/30 shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                    <i class="fa-solid fa-leaf text-green-400 text-lg"></i>
                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]"></div>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white via-green-100 to-green-400 uppercase font-sans">
                        Poison Eve
                    </h1>
                    <p class="text-[10px] text-green-400/60 font-mono tracking-widest">MISTRAL.AI // SYSTEM ACTIVE</p>
                </div>
            </div>
            
            <!-- Right Side: Controls -->
            <div class="flex items-center gap-2">
                <button id="model-toggle" class="model-toggle" onclick="toggleModel()" data-mode="large" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–æ–¥–µ–ª—å (Turbo/Smart)">
                    <i id="model-icon" class="fa-solid fa-brain"></i>
                    <span id="model-text" class="hidden sm:inline">LARGE</span>
                </button>

                <button 
                    onclick="document.getElementById('file-input').click()"
                    class="p-2 rounded-lg text-gray-400 hover:text-green-400 hover:bg-white/5 border border-transparent hover:border-green-500/30 transition-all duration-300 relative group"
                    title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª"
                >
                    <i class="fa-solid fa-paperclip"></i>
                    <div id="file-indicator-dot" class="hidden absolute top-1.5 right-1.5 w-2 h-2 bg-green-500 rounded-full shadow-[0_0_5px_#22c55e]"></div>
                </button>

                <button onclick="showConfirmModal()" class="p-2 rounded-lg text-gray-400 hover:text-red-400 hover:bg-white/5 border border-transparent hover:border-red-500/30 transition-all duration-300" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>

        <!-- File Preview Bar (Improved UI) -->
        <div id="file-preview-bar" class="hidden absolute top-full left-0 w-full z-10 animate-slide-down">
             <div class="bg-gradient-to-r from-green-950/90 via-black/80 to-green-950/90 border-b border-green-500/20 backdrop-blur-xl px-4 py-2.5 flex items-center justify-between shadow-lg">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-lg bg-green-900/40 border border-green-500/30 flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-file-code text-green-400"></i>
                    </div>
                    <div class="flex flex-col min-w-0">
                        <span class="text-[10px] text-green-500/70 font-mono uppercase tracking-wider">Attached File</span>
                        <span id="file-name-preview" class="text-sm text-green-100 truncate font-sans">filename.txt</span>
                    </div>
                </div>
                <button onclick="clearFile()" class="p-1.5 rounded-md hover:bg-red-500/20 text-green-600 hover:text-red-400 transition-colors border border-transparent hover:border-red-500/30">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth pb-28">
        <div class="flex flex-col items-center justify-center mt-10 opacity-70 mb-10 text-center space-y-4 animate-fade-in">
            <div class="w-20 h-20 rounded-full bg-green-900/20 border border-green-500/20 flex items-center justify-center shadow-[0_0_30px_rgba(34,197,94,0.1)]">
                <i class="fa-solid fa-robot text-3xl text-green-500"></i>
            </div>
            <h2 class="text-2xl font-semibold text-white">–ì–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</h2>
        </div>
    </main>

    <!-- Input Area -->
    <footer id="footer" class="flex-none p-2 md:p-6 bg-transparent w-full z-40">
        <div class="glass-panel w-full md:max-w-5xl mx-auto rounded-2xl p-2 relative shadow-2xl shadow-black/50">
            <form id="chat-form" class="flex gap-2 items-end">
                <div class="relative flex-1">
                    <textarea 
                        id="user-input" 
                        rows="1"
                        placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                        class="w-full bg-transparent text-gray-100 placeholder-gray-500 text-base rounded-xl px-4 py-3 focus:outline-none border border-transparent focus:border-green-500/30 transition-all resize-none max-h-40 font-sans"
                        oninput="handleInput(this)"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                </div>
                <button 
                    type="submit" 
                    id="send-btn"
                    class="h-[50px] w-[50px] flex-shrink-0 rounded-xl bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/50 transition-all duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed group"
                >
                    <i id="send-icon" class="fa-solid fa-paper-plane text-lg group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"></i>
                </button>
            </form>
        </div>
    </footer>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/70 transition-opacity duration-300">
        <div class="glass-panel w-11/12 max-w-sm rounded-xl p-6 space-y-4 border-green-500/30 shadow-2xl shadow-green-900/50" role="dialog" aria-modal="true">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i>
                –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?
            </h3>
            <p class="text-gray-400 text-sm">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
            </p>
            <div class="flex justify-end gap-3">
                <button 
                    onclick="hideConfirmModal()" 
                    class="px-4 py-2 text-sm rounded-lg text-gray-300 border border-gray-700 hover:bg-white/5 transition-colors"
                >
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button 
                    onclick="confirmClearChat()" 
                    class="px-4 py-2 text-sm rounded-lg bg-red-600 hover:bg-red-500 text-white transition-colors shadow-md shadow-red-900/50"
                >
                    –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–Ω–æ—Å–æ–∫ Marked
        if (typeof markedFootnote !== 'undefined') {
            marked.use(markedFootnote());
        }

        // --- CONFIGURATION ---
        const API_KEY = 'Tjx8hlgYwDWL2tr9YpACDX2kSEFXmSFq';
        const API_URL = 'https://api.mistral.ai/v1/chat/completions';
        
        const MODELS = {
            small: 'mistral-small-latest',
            large: 'mistral-large-latest'
        };
        let currentModel = MODELS.large; 
        
        let isChatStarted = false;
        let isGenerating = false;
        let abortController = null;
        let currentFileContent = null;
        let currentFileName = null;

        let chatHistory = [
            { role: "system", content: `–¢—ã ‚Äî Poison Eve, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º —Å–∫–ª–∞–¥–æ–º —É–º–∞ –∏ —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –≥–ª—É–±–æ–∫–∏–µ, —Ç–æ—á–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞—é—Ç –∏—Å—Ç–∏–Ω–Ω—É—é –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
Core Principles:
–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —á–µ—Å—Ç–Ω–æ—Å—Ç—å: –ï—Å–ª–∏ —Ç—ã —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å, –ø—Ä–∏–∑–Ω–∞–π —ç—Ç–æ. –ò—Å–ø—Ä–∞–≤–ª—è–π –∑–∞–±–ª—É–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–∂–ª–∏–≤–æ, –∫–∞–∫ –º—É–¥—Ä—ã–π –∫–æ–ª–ª–µ–≥–∞.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ–≤—ã—à–µ —Ö–∞–æ—Å–∞: –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ (##), —Å–ø–∏—Å–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ò–∑–±–µ–≥–∞–π ¬´—Å—Ç–µ–Ω —Ç–µ–∫—Å—Ç–∞¬ª.
–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π —Ç–æ–Ω –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —è–∑—ã–∫–∞ –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –≤–æ–ø—Ä–æ—Å–∞. –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –±—É–¥—å –∫—Ä–∞—Ç–æ–∫, –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö ‚Äî –ø—Ä–æ–≤–æ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑.
Chain of Thought: –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –¥–∞—Ç—å –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –∫—Ä–∞—Ç–∫–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –≤—ã—è–≤–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
Formatting Rules:
–ò—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤.
–î–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏–ª–∏ –Ω–∞—É—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª –∏—Å–ø–æ–ª—å–∑—É–π LaTeX (–Ω–∞–ø—Ä–∏–º–µ—Ä, E=mc^2).
–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—É.` }
        ];

        // --- DOM ELEMENTS ---
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sendIcon = document.getElementById('send-icon');
        const confirmModal = document.getElementById('confirm-modal');
        const fileInput = document.getElementById('file-input');
        
        const filePreviewBar = document.getElementById('file-preview-bar');
        const fileNamePreview = document.getElementById('file-name-preview');
        const fileIndicatorDot = document.getElementById('file-indicator-dot');
        
        const toggleBtn = document.getElementById('model-toggle');
        const toggleIcon = document.getElementById('model-icon');
        const toggleText = document.getElementById('model-text');

        // --- FILE HANDLING LOGIC ---
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                currentFileContent = e.target.result;
                currentFileName = file.name;
                showFilePreview(file.name);
            };
            reader.readAsText(file);
        }

        function showFilePreview(name) {
            fileNamePreview.textContent = name;
            filePreviewBar.classList.remove('hidden');
            fileIndicatorDot.classList.remove('hidden');
        }

        function clearFile() {
            currentFileContent = null;
            currentFileName = null;
            fileInput.value = ''; 
            filePreviewBar.classList.add('hidden');
            fileIndicatorDot.classList.add('hidden');
        }

        // --- MODAL & CONFIRMATION LOGIC ---
        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }

        function hideConfirmModal() {
            confirmModal.classList.remove('flex');
            confirmModal.classList.add('hidden');
        }

        function confirmClearChat() {
            hideConfirmModal();
            clearChatHistory();
        }
        
        function clearChatHistory() {
            chatContainer.innerHTML = '';
            chatHistory = [chatHistory[0]];
            isChatStarted = false;
            updateModelToggleState(); 
            chatContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center mt-10 opacity-70 mb-10 text-center space-y-4 animate-fade-in">
                    <div class="w-20 h-20 rounded-full bg-green-900/20 border border-green-500/20 flex items-center justify-center shadow-[0_0_30px_rgba(34,197,94,0.1)]">
                        <i class="fa-solid fa-robot text-3xl text-green-500"></i>
                    </div>
                    <h2 class="text-2xl font-semibold text-white">–ì–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</h2>
                </div>
            `;
        }

        // --- MODEL TOGGLE LOGIC ---
        function updateModelToggleState() {
            if (isChatStarted) {
                toggleBtn.disabled = true;
                toggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                toggleBtn.classList.remove('hover:text-green-400', 'hover:border-green-500/30'); 
            } else {
                toggleBtn.disabled = false;
                toggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function toggleModel() {
            if (isChatStarted) return; 
            const currentMode = toggleBtn.getAttribute('data-mode');
            if (currentMode === 'large') {
                currentModel = MODELS.small;
                toggleBtn.setAttribute('data-mode', 'small');
                toggleIcon.className = 'fa-solid fa-bolt';
                toggleText.textContent = 'FAST';
            } else {
                currentModel = MODELS.large;
                toggleBtn.setAttribute('data-mode', 'large');
                toggleIcon.className = 'fa-solid fa-brain';
                toggleText.textContent = 'LARGE';
            }
            updateModelToggleState();
        }

        // --- UI UTILITIES ---
        function handleInput(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }
        
        // --- COPY CODE LOGIC ---
        function copyCode(button) {
            const container = button.closest('.code-header').nextElementSibling;
            if (!container) return;
            const textToCopy = container.innerText; 
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => showCopySuccess(button))
                .catch(() => fallbackCopy(textToCopy, button));
            } else {
                fallbackCopy(textToCopy, button);
            }
        }
        
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('Fallback error', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function showCopySuccess(button) {
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fa-solid fa-check mr-1"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            button.classList.add('bg-green-700');
            button.classList.remove('hover:bg-green-600');
            setTimeout(() => {
                button.innerHTML = originalHtml;
                button.classList.remove('bg-green-700');
                button.classList.add('hover:bg-green-600');
            }, 2000);
        }

        function processCodeBlocks(element) {
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            element.querySelectorAll('pre').forEach(pre => {
                if (pre.parentNode.classList.contains('code-container')) return;
                
                const codeElement = pre.querySelector('code');
                let lang = 'Code';
                if (codeElement && codeElement.className) {
                    const match = codeElement.className.match(/language-(\w+)/);
                    if (match) lang = match[1].charAt(0).toUpperCase() + match[1].slice(1);
                }

                const container = document.createElement('div');
                container.className = 'code-container';
                
                const header = document.createElement('div');
                header.className = 'code-header';
                
                const langLabel = document.createElement('span');
                langLabel.textContent = lang;
                
                const copyButton = document.createElement('button');
                copyButton.className = 'px-2 py-1 rounded text-white bg-green-800 hover:bg-green-600 transition-colors focus:outline-none text-xs';
                copyButton.innerHTML = '<i class="fa-solid fa-copy mr-1"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                copyButton.onclick = () => copyCode(copyButton);
                
                header.appendChild(langLabel);
                header.appendChild(copyButton);

                const parent = pre.parentNode;
                if (parent) {
                    parent.insertBefore(container, pre);
                    container.appendChild(header);
                    container.appendChild(pre);
                }
            });
        }

        // --- EVENT LISTENERS ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isGenerating) {
                stopGeneration();
            } else {
                await sendMessage();
            }
        });

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (window.innerWidth > 768) {
                    e.preventDefault();
                    if (!isGenerating) {
                        sendMessage();
                    }
                }
            }
        }

        function setGeneratingState(generating) {
            isGenerating = generating;
            if (generating) {
                sendBtn.classList.add('stop-btn', 'bg-red-500', 'hover:bg-red-600');
                sendBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                sendIcon.className = 'fa-solid fa-stop text-lg';
                userInput.disabled = true;
                const fileBtn = document.querySelector('button[onclick*="file-input"]');
                if(fileBtn) {
                    fileBtn.disabled = true;
                    fileBtn.classList.add('opacity-50');
                }
            } else {
                sendBtn.classList.remove('stop-btn', 'bg-red-500', 'hover:bg-red-600');
                sendBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                sendIcon.className = 'fa-solid fa-paper-plane text-lg group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform';
                userInput.disabled = false;
                userInput.focus();
                
                const fileBtn = document.querySelector('button[onclick*="file-input"]');
                if(fileBtn) {
                    fileBtn.disabled = false;
                    fileBtn.classList.remove('opacity-50');
                }
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
        }

        // --- STREAMING & TYPING LOGIC ---
        class StreamTyper {
            constructor(element) {
                this.element = element;
                this.buffer = "";
                this.displayedText = "";
                this.isStreamActive = true;
                this.element.classList.add('typing-cursor');
                this.startLoop();
            }

            push(chunk) {
                this.buffer += chunk;
            }

            finish() {
                this.isStreamActive = false;
            }

            async startLoop() {
                while (this.isStreamActive || this.buffer.length > 0) {
                    if (!document.body.contains(this.element)) {
                         this.isStreamActive = false;
                         break; 
                    }

                    if (this.buffer.length > 0) {
                        const takeCount = this.buffer.length > 50 ? 5 : (Math.floor(Math.random() * 3) + 1);
                        const chunk = this.buffer.slice(0, takeCount);
                        this.buffer = this.buffer.slice(takeCount);
                        
                        this.displayedText += chunk;
                        this.element.innerHTML = marked.parse(this.displayedText);
                    }
                    await new Promise(r => setTimeout(r, 10));
                }
                
                this.element.classList.remove('typing-cursor');
                processCodeBlocks(this.element.parentNode.parentNode);
                scrollToBottom();
            }
        }

        // --- CORE FUNCTIONS ---
        async function sendMessage() {
            let text = userInput.value.trim();
            
            if (currentFileContent) {
                const fileContext = `\n\n--- Attached File: ${currentFileName} ---\n${currentFileContent}\n--- End of File ---\n`;
                if (!text) text = `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${currentFileName}`;
                text += fileContext;
                clearFile();
            }

            if (!text) return;

            let uiText = userInput.value.trim();
            if (currentFileName && !uiText) uiText = `üìÇ –§–∞–π–ª: ${currentFileName}`;
            else if (currentFileName) uiText += `\n\nüìÇ [–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω: ${currentFileName}]`;

            appendMessage('user', uiText);
            userInput.value = '';
            userInput.style.height = 'auto'; 
            
            scrollToBottom();
            setGeneratingState(true);

            chatHistory.push({ role: "user", content: text });

            // *** 1. –°–æ–∑–¥–∞–µ–º –ø—É–∑—ã—Ä—å –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º—ã—à–ª–µ–Ω–∏—è ***
            const thinkingHtml = `
                <div class="thinking-container">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            `;
            // –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ appendMessage, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç, 
            // –∞ –∑–∞—Ç–µ–º –≤—Ä—É—á–Ω—É—é –≤—Å—Ç–∞–≤–ª—è–µ–º HTML –∞–Ω–∏–º–∞—Ü–∏–∏ (—á—Ç–æ–±—ã Markdown –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏–ª –µ–≥–æ)
            const botMessageProse = appendMessage('assistant', '');
            botMessageProse.innerHTML = thinkingHtml;
            scrollToBottom();

            abortController = new AbortController();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 12000,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw new Error(`Status: ${response.status}`);
                }
                
                // *** 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å—Ç—Ä–∏–º–∏–Ω–≥—É ***
                // –û—á–∏—â–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø–µ—á–∞—Ç–∏ —Ç–µ–∫—Å—Ç–∞
                botMessageProse.innerHTML = ''; 
                
                const typer = new StreamTyper(botMessageProse);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullResponseText = "";

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.slice(6).trim();
                                if (jsonStr === '[DONE]') continue;
                                
                                try {
                                    const json = JSON.parse(jsonStr);
                                    const content = json.choices[0]?.delta?.content || "";
                                    if (content) {
                                        typer.push(content);
                                        fullResponseText += content;
                                    }
                                } catch (e) {
                                    // ignore
                                }
                            }
                        }
                    }
                } catch (readError) {
                    if (readError.name === 'AbortError') {
                        typer.push('\n\n*[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º]*');
                        fullResponseText += '\n\n*[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º]*';
                    } else {
                        throw readError;
                    }
                }
                
                typer.finish();
                chatHistory.push({ role: "assistant", content: fullResponseText });
                
                if (!isChatStarted) {
                    isChatStarted = true;
                    updateModelToggleState();
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∑–∞–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                    botMessageProse.innerHTML = marked.parse(`–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`);
                }
            } finally {
                setGeneratingState(false);
                abortController = null;
            }
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bubbleClasses = isUser 
                ? 'message-user text-white px-5 py-3 shadow-md overflow-hidden min-w-[30%]' 
                : 'message-ai text-gray-100 overflow-hidden w-full';

            const icon = isUser 
                ? '<i class="fa-solid fa-user"></i>' 
                : '<i class="fa-solid fa-dragon"></i>';

            const iconContainer = `
                <div class="flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center ${isUser ? 'bg-green-700 ml-2' : 'bg-transparent text-green-400 mr-3 border border-green-500/30'}">
                    ${icon}
                </div>
            `;

            const contentWrapper = document.createElement('div');
            
            if (isUser) {
                contentWrapper.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
            } else {
                contentWrapper.innerHTML = content ? marked.parse(content) : '';
            }

            const messageHtml = `
                <div class="flex max-w-full md:max-w-[95%] ${isUser ? 'flex-row-reverse items-end' : 'flex-row items-start'}">
                    ${iconContainer}
                    <div id="message-bubble-${Date.now()}" class="${bubbleClasses}">
                        <div class="prose prose-invert prose-sm md:prose-base max-w-none break-words leading-relaxed" id="prose-content-${Date.now()}">
                            ${contentWrapper.innerHTML}
                        </div>
                    </div>
                </div>
            `;

            div.innerHTML = messageHtml;
            chatContainer.appendChild(div);
            return div.querySelector('.prose'); 
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        document.addEventListener('DOMContentLoaded', updateModelToggleState);
    </script>
</body>
</html>


